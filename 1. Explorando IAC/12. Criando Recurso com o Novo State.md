**Resumo da Aula: Migra√ß√£o do Backend do Pulumi para AWS S3 (Passo Final)**  

---

### **Objetivo da Aula**  
Finalizar a migra√ß√£o do backend do Pulumi para o AWS S3, validar o funcionamento da nova configura√ß√£o e garantir que a pipeline CI/CD opere corretamente com o novo estado remoto.  

---

### **Conceitos Relevantes**  
1. **Estado (State File)**:  
   - Arquivo JSON que registra o estado atual da infraestrutura.  
   - Compara o c√≥digo declarativo com o estado salvo para definir a√ß√µes (criar/atualizar/deletar recursos).  
   - **Import√¢ncia**: Evita duplica√ß√£o e conflitos.  

2. **Backend Self-Hosted**:  
   - Uso de um bucket S3 para armazenar o estado, substituindo o Pulumi Cloud.  
   - **Vantagens**: Controle total, redu√ß√£o de *vendor lock-in*, custos gerenci√°veis.  

---

### **Passo a Passo da Migra√ß√£o**  

#### **1. Destrui√ß√£o dos Recursos Antigos**  
```bash  
pulumi destroy --yes       # Remove recursos da stack atual  
pulumi stack rm staging    # Deleta a stack do Pulumi Cloud  
```  

#### **2. Cria√ß√£o do Bucket S3 para o Estado**  
- **Configura√ß√µes do Bucket**:  
  - Nome: `rocketseat-pulumi-state` (globalmente √∫nico).  
  - Versionamento habilitado (backup e hist√≥rico).  
  - Bloqueio de acesso p√∫blico.  
  - Tag: `IaC: true`.  

#### **3. Reconfigura√ß√£o do Pulumi**  
```bash  
pulumi login s3://rocketseat-pulumi-state  # Define o S3 como novo backend  
pulumi stack init staging                  # Recria a stack no S3  
```  

#### **4. Ajustes na Pipeline (GitHub Actions)**  
- **Remo√ß√£o de Vari√°veis Antigas**:  
  - Exclua `PULUMI_ACCESS_TOKEN` (n√£o √© mais necess√°rio).  
- **Novas Vari√°veis de Ambiente**:  
  - `AWS_ACCESS_KEY_ID` e `AWS_SECRET_ACCESS_KEY` (credenciais da AWS).  
  - `PULUMI_BACKEND_URL`: `s3://rocketseat-pulumi-state`.  

#### **5. Teste Pr√°tico: Cria√ß√£o de um Novo Bucket S3**  
- **C√≥digo (index.ts)**:  
  ```typescript  
  import * as aws from "@pulumi/aws";  

  // Cria√ß√£o de um novo bucket S3  
  const secondBucket = new aws.s3.Bucket("segundo-bucket-rocketseat", {  
    tags: {  
      "ManagedBy": "IaC",  
      "IaC": "true",  
    },  
  });  
  ```  
- **Comandos**:  
  ```bash  
  git add .  
  git commit -m "Adiciona segundo bucket S3"  
  git push  
  ```  

---

### **Desafios Encontrados e Solu√ß√µes**  
1. **Erro na Pipeline**:  
   - **Causa**: Falta da vari√°vel `PULUMI_BACKEND_URL` no GitHub Actions.  
   - **Solu√ß√£o**: Adicionar a vari√°vel com o valor `s3://rocketseat-pulumi-state`.  

2. **Stack N√£o Encontrada**:  
   - **Causa**: Nome incorreto da stack (`stg` vs. `staging`).  
   - **Solu√ß√£o**: Padronizar o nome da stack no c√≥digo e na pipeline.  

3. **Senha do Estado**:  
   - **Causa**: Prompt de senha n√£o configurado.  
   - **Solu√ß√£o**: Usar `pulumi config set --secret` para criptografar senhas ou deixar vazio em ambientes de teste.  

---

### **Boas Pr√°ticas Consolidadas**  
1. **Versionamento do Bucket S3**:  
   - Permite rollback para vers√µes anteriores do estado em caso de erro.  
2. **IAM Least Privilege**:  
   - Restrinja as permiss√µes do IAM ao bucket (ex: `s3:PutObject`, `s3:GetObject`).  
3. **Backups Automatizados**:  
   - Use `aws s3 sync` para backups peri√≥dicos do estado.  

---

### **Valida√ß√£o do Processo**  
1. **Verifica√ß√£o no S3**:  
   - Acesse o bucket `rocketseat-pulumi-state` e confira o arquivo de estado atualizado.  
2. **Pipeline Funcionando**:  
   - A√ß√µes do GitHub devem criar/atualizar recursos sem depender do Pulumi Cloud.  
3. **Recursos na AWS**:  
   - Confirme a cria√ß√£o do `segundo-bucket-rocketseat` no console da AWS.  

---

### **Pr√≥ximos Passos**  
1. **Gerenciamento de Recursos Complexos**:  
   - Criar EC2, ECR ou Lambda Functions usando o novo backend.  
2. **Migra√ß√£o de Stacks Existentes**:  
   - Use `pulumi stack export` e `pulumi stack import` para migrar outras stacks sem perder recursos.  
3. **Monitoramento**:  
   - Configure alertas no CloudWatch para detectar altera√ß√µes fora do IaC.  

---

**Conclus√£o**:  
A migra√ß√£o para o S3 como backend refor√ßa a autonomia e a flexibilidade do Pulumi, permitindo infraestrutura resiliente e alinhada a boas pr√°ticas de DevOps. Embora desafios de configura√ß√£o possam surgir, a solu√ß√£o oferece controle total e seguran√ßa. No pr√≥ximo m√≥dulo, avan√ßaremos para deploy de aplica√ß√µes em cloud com recursos mais complexos! üöÄ