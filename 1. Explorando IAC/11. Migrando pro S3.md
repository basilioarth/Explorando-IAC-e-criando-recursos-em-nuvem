**Resumo da Aula: Migra√ß√£o do Backend do Pulumi para AWS S3**  

---

### **Objetivo da Aula**  
Migrar o armazenamento do estado (*state file*) do Pulumi do **Pulumi Cloud** para um **bucket S3 da AWS**, garantindo autonomia e evitando *vendor lock-in*.  

---

### **Conceitos-Chave**  

#### **1. Estado (State File)**  
- **O que √©**: Arquivo JSON que registra o estado atual da infraestrutura gerenciada pelo Pulumi.  
- **Import√¢ncia**: Compara o c√≥digo declarativo com o estado salvo para determinar a√ß√µes (criar, atualizar, destruir recursos).  
- **Localiza√ß√£o**: Originalmente no Pulumi Cloud; migrado para um bucket S3.  

#### **2. Motiva√ß√£o para Migra√ß√£o**  
- **Autonomia**: Controle total sobre o armazenamento do estado.  
- **Evitar Vendor Lock-in**: Reduz depend√™ncia do Pulumi Cloud.  
- **Custos**: Gerenciamento direto em infraestrutura pr√≥pria.  

---

### **Passo a Passo da Migra√ß√£o**  

#### **1. Destrui√ß√£o dos Recursos Existente**  
```bash  
pulumi destroy --yes  # Remove recursos da stack atual  
pulumi stack rm staging  # Deleta a stack do Pulumi Cloud  
```  

#### **2. Cria√ß√£o do Bucket S3 para Estado**  
- **Na AWS**:  
  - Nome: `rocketseat-pulumi-state` (globalmente √∫nico).  
  - Configura√ß√µes:  
    - Bloqueio de acesso p√∫blico.  
    - Versionamento habilitado (para backup e hist√≥rico).  
    - Tag: `IaC: true`.  

#### **3. Reconfigura√ß√£o do Pulumi**  
```bash  
pulumi login s3://rocketseat-pulumi-state  # Define o S3 como novo backend  
pulumi stack init staging  # Recria a stack no S3  
```  

#### **4. Ajustes na Pipeline CI/CD (GitHub Actions)**  
- **Remo√ß√£o do Pulumi Cloud**:  
  - Excluir vari√°veis relacionadas ao Pulumi Cloud (ex: `PULUMI_ACCESS_TOKEN`).  
- **Novas Vari√°veis**:  
  - `AWS_ACCESS_KEY_ID` e `AWS_SECRET_ACCESS_KEY` para autentica√ß√£o na AWS.  
  - `PULUMI_BACKEND_URL`: `s3://rocketseat-pulumi-state`.  

---

### **Comandos √öteis**  
| **Comando**               | **Descri√ß√£o**                                      |  
|---------------------------|---------------------------------------------------|  
| `pulumi stack ls`          | Lista todas as stacks gerenciadas.                |  
| `pulumi stack export`      | Exporta o estado atual para um arquivo JSON.      |  
| `pulumi login s3://<bucket>` | Configura o S3 como backend para o estado.       |  

---

### **Desafios e Solu√ß√µes**  
- **Erro na Pipeline**:  
  - **Causa**: Falta da vari√°vel `PULUMI_BACKEND_URL` no GitHub Actions.  
  - **Solu√ß√£o**: Adicionar a vari√°vel com o valor `s3://rocketseat-pulumi-state`.  
- **Senha do Estado**:  
  - **Boas Pr√°ticas**: Use `pulumi config set --secret` para criptografar senhas sens√≠veis.  

---

### **Boas Pr√°ticas**  
1. **Versionamento do Bucket S3**:  
   - Permite recuperar vers√µes anteriores do estado em caso de erro.  
2. **IAM Least Privilege**:  
   - Restrinja permiss√µes do IAM ao bucket S3 (ex: `s3:PutObject`, `s3:GetObject`).  
3. **Backups Autom√°ticos**:  
   - Use scripts ou ferramentas como `aws s3 sync` para backups peri√≥dicos.  

---

### **Pr√≥ximos Passos**  
1. **Pol√≠ticas de Seguran√ßa**:  
   - Configurar *Bucket Policies* para bloquear acesso n√£o autorizado ao S3.  
2. **Migra√ß√£o de Stacks Existentes**:  
   - Use `pulumi stack export` e `pulumi stack import` para migrar outras stacks.  
3. **Monitoramento**:  
   - Integre alertas do CloudWatch para detectar altera√ß√µes n√£o gerenciadas por IaC.  

---

**Conclus√£o**:  
A migra√ß√£o para o S3 como backend refor√ßa a flexibilidade do Pulumi, permitindo infraestrutura aut√¥noma e resiliente. Embora o Pulumi Cloud ofere√ßa conveni√™ncia, solu√ß√µes self-hosted como o S3 s√£o ideais para ambientes com requisitos espec√≠ficos de governan√ßa e seguran√ßa. Na pr√≥xima aula, exploraremos a cria√ß√£o de recursos complexos (ex: EC2, ECR) com o novo backend! üõ†Ô∏è